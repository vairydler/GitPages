<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>ミリ秒タイマ</title>
</head>
<body>
</body>
<script type="text/javascript" src="js/FuncToWorker.js"></script>
<script type="text/javascript">	
    const timerWorkerLogic =
    function() {
        let timerInterval;
        let startTime;

        self.onmessage = function(e) {
            if (e.data === 'start') {
                startTime = Date.now(); 
				let cnt = function() {
					const elapsedTime = Date.now() - startTime;
					self.postMessage(elapsedTime); // 経過時間をミリ秒で送信
				};
				timerInterval = setInterval(cnt,1);
            } else if (e.data === 'stop') {
                clearInterval(timerInterval);
            }
        };
    }

	const timeformat=
	function(time)
	{
		timedata = [ 
			{ unit:1000, digit:3, headjoint:".", },/* ms   */
			{ unit:60,   digit:2, headjoint:":", },/* sec  */
			{ unit:60,   digit:2, headjoint:":", },/* min  */
			{ unit:60,   digit:2, headjoint:"",  },/* hour */
		];

		return timedata.reduce( (a,e)=>{
			let calc;

			calc = (time % e.unit);
			time = Math.floor( time / e.unit);

			return e.headjoint + String( calc ).padStart( e.digit, '0' ) + a;
		},"");
	};

	const getQuery=
	function()
	{
		let ret = {
			format:"",
		};
		
		// 1. 現在のURLのクエリパラメータをすべて取得
		const urlParams = new URLSearchParams(window.location.search);

		// 2. パラメータの値をキーで取得する
		Object.keys( ret ).forEach( (e,i,a)=>{
			ret[ e ] = urlParams.get( e );
		});

		return ret;
	};

	const formatertable={
		"0" : (time)=>time,
		"1" : timeformat
	};

	const main=
	function(){
	    let workerManagers = [];
	    let queryParam = getQuery();

	    // ページを閉じる際に全てのWorkerを終了させる
	    window.addEventListener('beforeunload', () => {
	        workerManagers.forEach((e,i,a) => {
	            e.manager.worker.postMessage('stop'); // 停止シグナル（あれば）
	            e.manager.terminate(); // 全てのWorkerと関連リソースを解放
	        });
	        workerManagers.length = 0; // 配列をクリア
	        console.log("ページが閉じられる前に全てのWorkerが解放されました。");
	    });

	    workerManagers.push( createWorkerFromFunction(timerWorkerLogic) );

	    // 生成されたWorkerインスタンスにonmessageハンドラを設定
		let body = document.body;
	    workerManagers[0].worker.onmessage = function(e) {
			body.innerHTML = formatertable[ queryParam.format ]( e.data );
	    };
	    workerManagers[0].worker.postMessage('start');
    };

    main();

</script>
</html>